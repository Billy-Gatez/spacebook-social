<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spacebook Â· Messages</title>
<link rel="stylesheet" href="/assets/css/styles.css"/>
<style>
  * { box-sizing: border-box; }
  body { overflow: hidden; background: #0a0a0a; color: #f2f2f2; font-family: Arial, sans-serif; }

  .msg-layout { display: flex; height: calc(100vh - 58px); }

  .conv-list { width: 300px; border-right: 1px solid #222; overflow-y: auto; background: #0f0f0f; flex-shrink: 0; display: flex; flex-direction: column; }
  .conv-list-header { padding: 14px 16px; border-bottom: 1px solid #222; font-weight: 700; color: #ff6a00; display: flex; justify-content: space-between; align-items: center; font-size: 15px; background: #111; }
  .conv-search { padding: 10px 12px; border-bottom: 1px solid #1a1a1a; }
  .conv-search input { width: 100%; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 20px; padding: 7px 14px; color: #f2f2f2; font-size: 13px; outline: none; }
  .conv-search input:focus { border-color: #ff6a00; }
  .conv-item { padding: 11px 14px; cursor: pointer; border-bottom: 1px solid #161616; display: flex; gap: 10px; align-items: center; transition: background .15s; position: relative; }
  .conv-item:hover { background: #161616; }
  .conv-item.active { background: #1a1a1a; border-left: 3px solid #ff6a00; }
  .conv-avatar { width: 42px; height: 42px; border-radius: 50%; background: #333; border: 2px solid #ff6a00; object-fit: cover; flex-shrink: 0; }
  .conv-info { flex: 1; min-width: 0; }
  .conv-name { font-weight: 700; font-size: 13px; color: #f2f2f2; }
  .conv-last { font-size: 11px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
  .conv-delete-btn { opacity: 0; background: none; border: none; color: #ff4444; font-size: 16px; cursor: pointer; padding: 4px 6px; border-radius: 4px; transition: opacity .15s; flex-shrink: 0; }
  .conv-item:hover .conv-delete-btn { opacity: 1; }
  .online-dot { width: 9px; height: 9px; border-radius: 50%; background: #22c55e; display: inline-block; margin-left: 4px; vertical-align: middle; flex-shrink: 0; }

  .chat-panel { flex: 1; display: flex; flex-direction: column; background: #0d0d0d; min-width: 0; }
  .chat-header { padding: 12px 20px; border-bottom: 1px solid #222; background: #111; display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 15px; min-height: 58px; justify-content: space-between; }
  .chat-header-left { display: flex; align-items: center; gap: 12px; }
  .chat-header-actions { display: flex; gap: 8px; }
  .chat-messages { flex: 1; overflow-y: auto; padding: 20px 24px; display: flex; flex-direction: column; gap: 6px; }
  .chat-messages::-webkit-scrollbar { width: 4px; }
  .chat-messages::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

  .msg-row { display: flex; flex-direction: column; }
  .msg-row.mine { align-items: flex-end; }
  .msg-row.theirs { align-items: flex-start; }
  .msg-bubble { max-width: 62%; padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.5; word-break: break-word; position: relative; }
  .msg-bubble.mine { background: linear-gradient(135deg, #ff6a00, #ff8c32); color: #000; border-bottom-right-radius: 3px; }
  .msg-bubble.theirs { background: #1c1c1c; border: 1px solid #2a2a2a; color: #f2f2f2; border-bottom-left-radius: 3px; }
  .msg-sender { font-size: 11px; color: #ff6a00; margin-bottom: 3px; font-weight: 700; padding-left: 2px; }
  .msg-time { font-size: 10px; color: rgba(255,255,255,0.35); margin-top: 4px; text-align: right; }
  .msg-bubble.mine .msg-time { color: rgba(0,0,0,0.45); }
  .msg-media { max-width: 220px; border-radius: 10px; margin-top: 6px; display: block; cursor: pointer; }
  .sc-preview { background: #111; border: 1px solid #ff6a00; border-radius: 8px; padding: 8px; margin-top: 6px; font-size: 12px; }

  .msg-reactions-row { display: flex; gap: 4px; margin-top: 5px; flex-wrap: wrap; }
  .rxn-chip { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 20px; padding: 3px 8px; font-size: 13px; cursor: pointer; transition: all .15s; display: flex; align-items: center; gap: 3px; }
  .rxn-chip:hover { border-color: #ff6a00; background: #222; }
  .rxn-count { font-size: 11px; color: #888; }

  .react-picker-row { display: none; gap: 5px; margin-top: 5px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 20px; padding: 4px 8px; width: fit-content; }
  .msg-bubble:hover .react-picker-row { display: flex; }
  .react-picker-row span { cursor: pointer; font-size: 17px; transition: transform .1s; }
  .react-picker-row span:hover { transform: scale(1.3); }

  .msg-delete-btn { display: none; background: none; border: none; color: #ff4444; font-size: 12px; cursor: pointer; padding: 2px 6px; border-radius: 4px; margin-top: 2px; }
  .msg-row.mine:hover .msg-delete-btn { display: inline-block; }

  .typing-bar { min-height: 22px; padding: 2px 24px 4px; font-size: 12px; color: #666; font-style: italic; }

  .chat-input-row { padding: 12px 16px; border-top: 1px solid #222; background: #111; display: flex; gap: 8px; align-items: flex-end; }
  .chat-input-row textarea { resize: none; height: 42px; flex: 1; margin-bottom: 0; font-size: 14px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 20px; padding: 10px 16px; color: #f2f2f2; outline: none; transition: border .15s; }
  .chat-input-row textarea:focus { border-color: #ff6a00; }
  .icon-btn { background: #1a1a1a; border: 1px solid #2a2a2a; color: #ff6a00; padding: 10px 12px; border-radius: 50%; cursor: pointer; font-size: 17px; flex-shrink: 0; line-height: 1; transition: all .15s; }
  .icon-btn:hover { background: #222; border-color: #ff6a00; }
  .icon-btn.recording { background: #ff6a00; color: #000; }
  #file-input { display: none; }

  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.8); z-index: 500; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal-box { background: #141414; border: 1px solid #ff6a00; border-radius: 14px; padding: 28px; width: 360px; box-shadow: 0 0 40px rgba(255,106,0,0.15); }
  .modal-box h3 { color: #ff6a00; margin-bottom: 18px; font-size: 16px; }
  .modal-box input[type="text"] { width: 100%; margin-bottom: 12px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; padding: 10px 14px; color: #f2f2f2; font-size: 14px; outline: none; }
  .modal-box input[type="text"]:focus { border-color: #ff6a00; }
  .friend-check-list { max-height: 200px; overflow-y: auto; margin-bottom: 14px; border: 1px solid #222; border-radius: 8px; padding: 6px; }
  .friend-check-item { display: flex; align-items: center; gap: 10px; padding: 6px 4px; font-size: 14px; border-radius: 6px; }
  .friend-check-item:hover { background: #1a1a1a; }
  .modal-actions { display: flex; gap: 10px; margin-top: 4px; }
  .btn-danger { background: #2a0a0a; border: 1px solid #ff4444; color: #ff4444; padding: 9px 18px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; transition: all .15s; }
  .btn-danger:hover { background: #ff4444; color: #fff; }
  .btn-ghost { background: none; border: 1px solid #333; color: #888; padding: 9px 18px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all .15s; }
  .btn-ghost:hover { border-color: #555; color: #ccc; }

  .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #444; gap: 10px; }
  .empty-state .empty-icon { font-size: 48px; }
</style>
</head>
<body>
<nav class="navbar">
  <a class="logo" href="/feed">Spacebook</a>
  <div class="nav-links">
    <a href="/feed">Feed</a>
    <a href="/profile">Profile</a>
    <a href="/messages" style="color:#ff6a00">Messages</a>
    <a href="/stories">Stories</a>
    <a href="/gallery">Gallery</a>
    <a href="/artist-dashboard">Artist</a>
    <a href="/logout">Logout</a>
  </div>
</nav>

<div class="msg-layout">
  <div class="conv-list">
    <div class="conv-list-header">
      Messages
      <button class="icon-btn" style="border-radius:8px;padding:5px 12px;font-size:12px;font-weight:700" onclick="openGroupModal()">+ Group</button>
    </div>
    <div class="conv-search">
      <input type="text" id="conv-search-input" placeholder="ðŸ”  Search conversationsâ€¦" oninput="filterConvs(this.value)"/>
    </div>
    <div id="conv-list-items"></div>
  </div>

  <div class="chat-panel">
    <div class="chat-header" id="chat-header">
      <div class="chat-header-left">
        <span style="color:#444;font-weight:400">Select a conversation</span>
      </div>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="empty-state">
        <div class="empty-icon">ðŸ’¬</div>
        <div>Pick a conversation to start messaging</div>
      </div>
    </div>
    <div class="typing-bar" id="typing-bar"></div>
    <div class="chat-input-row">
      <button class="icon-btn" id="voice-btn" title="Hold for voice note">ðŸŽ™</button>
      <button class="icon-btn" onclick="document.getElementById('file-input').click()" title="Attach file">ðŸ“Ž</button>
      <input type="file" id="file-input" accept="image/*,video/*" onchange="handleFileAttach(event)"/>
      <textarea id="msg-input" placeholder="Type a messageâ€¦ or paste a SoundCloud link" oninput="handleTypingInput()" onkeydown="handleMsgKeydown(event)"></textarea>
      <button class="btn-primary" style="width:auto;padding:10px 20px;flex-shrink:0;border-radius:20px" onclick="sendTextMessage()">Send</button>
    </div>
  </div>
</div>

<!-- New Group Modal -->
<div class="modal-overlay" id="group-overlay">
  <div class="modal-box">
    <h3>âœ¨ New Group Chat</h3>
    <input type="text" id="group-name-input" placeholder="Group name"/>
    <div class="friend-check-list" id="friend-check-list"></div>
    <div class="modal-actions">
      <button class="btn-primary" onclick="submitGroupCreate()" style="flex:1">Create Group</button>
      <button class="btn-ghost" onclick="closeGroupModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Delete Conversation Confirm Modal -->
<div class="modal-overlay" id="delete-conv-overlay">
  <div class="modal-box">
    <h3>ðŸ—‘ Delete Conversation?</h3>
    <p style="color:#888;font-size:14px;margin-bottom:20px">This will permanently delete this conversation and all its messages for everyone.</p>
    <div class="modal-actions">
      <button class="btn-danger" onclick="confirmDeleteConv()" style="flex:1">Yes, Delete</button>
      <button class="btn-ghost" onclick="closeDeleteConvModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Socket.IO from CDN (fixes 404 on custom path) -->
<script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>
<script src="/modules/messaging-client.js"></script>
</body>
</html>
